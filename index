<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø³Ø§Ø¨Ø§Øª - Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background: #F8F9FA; }
        .gold-card { background: linear-gradient(135deg, #FFD200 0%, #F7971E 100%); border-radius: 25px; }
        .hidden { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="login_screen" class="flex-1 flex flex-col justify-center p-8">
        <h1 class="text-4xl font-black text-yellow-500 mb-2">Ø­Ø³Ø§Ø¨Ø§Øª</h1>
        <p class="mb-8 text-gray-500">Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª! ØªÚ©Ø§ÛŒÛ• Ø¨Ú†Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</p>
        <input type="email" id="log_email" placeholder="Ø¦ÛŒÙ…Û•ÛŒÚµ" class="w-full p-4 mb-4 bg-white rounded-2xl shadow-sm outline-none border border-gray-100">
        <input type="password" id="log_pass" placeholder="Ù¾Ø§Ø³ÙˆÛ†Ø±Ø¯" class="w-full p-4 mb-6 bg-white rounded-2xl shadow-sm outline-none border border-gray-100">
        <button onclick="loginUser()" class="w-full bg-black text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
    </div>

    <div id="pin_screen" class="hidden flex-1 flex flex-col justify-center items-center p-8 bg-yellow-500 text-white text-center">
        <h2 class="text-2xl font-black mb-2">Ù¾Ø§Ø±Ø§Ø³ØªÙ†ÛŒ Ù‡Û•Ú˜Ù…Ø§Ø±</h2>
        <p class="mb-8 opacity-90">ØªÚ©Ø§ÛŒÛ• Ú©Û†Ø¯ÛŒ PIN Ø¨Ù†ÙˆÙˆØ³Û• Ø¨Û† Ú†ÙˆÙˆÙ†Û• Ù†Ø§ÙˆÛ•ÙˆÛ•</p>
        <div id="pin_container" class="glass-panel p-8 rounded-[40px] shadow-2xl w-full max-w-sm">
            <input type="password" id="pin_input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" class="w-full text-center text-4xl p-4 bg-yellow-50 rounded-2xl text-yellow-700 outline-none border-2 border-yellow-200 mb-6 font-mono">
            <button onclick="checkPin()" class="w-full bg-yellow-600 text-white py-4 rounded-2xl font-bold shadow-md active:scale-95 transition">Ù¾Ø´ØªÚ•Ø§Ø³ØªÚ©Ø±Ø¯Ù†Û•ÙˆÛ•</button>
        </div>
    </div>

    <div id="main_screen" class="hidden flex-1 p-4 pb-48">
        <div class="flex justify-between items-center mb-6">
            <div id="user_name" class="bg-yellow-400 text-white px-4 py-2 rounded-full font-bold shadow-sm">...</div>
            <button onclick="logout()" class="p-2 bg-white rounded-full shadow-md">ğŸšª</button>
        </div>

        <div class="gold-card p-6 text-white text-center shadow-xl mb-6">
            <p class="text-xs opacity-80">Ú•Û•Ø³ÛŒØ¯ÛŒ Ø¦ÛØ³ØªØ§</p>
            <h2 id="balance" class="text-4xl font-black my-1">0</h2>
            <div id="dollar_rate" class="bg-black/20 px-3 py-1 rounded-full text-xs inline-block">0$</div>
            <div class="mt-4 bg-white/30 h-3 rounded-full overflow-hidden">
                <div id="progress_bar" class="bg-green-400 h-full transition-all duration-1000" style="width: 0%"></div>
            </div>
        </div>

        <input type="text" id="search_box" oninput="searchTransactions()" placeholder="Ú¯Û•Ú•Ø§Ù† Ø¨Û† Ù†Ø§Ùˆ..." class="w-full p-4 rounded-2xl border-none shadow-sm mb-6 outline-none text-right">

        <div id="transaction_list" class="space-y-3">
            </div>

        <div class="fixed bottom-0 left-0 right-0 glass-panel p-4 rounded-t-[40px] shadow-[0_-10px_30px_rgba(0,0,0,0.05)] border-t border-white">
            <div class="flex gap-2 mb-2">
                <input type="number" id="inp_amt" placeholder="Ù¾Ø§Ø±Û•" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none">
                <input type="text" id="inp_cli" placeholder="Ú©Ú•ÛŒØ§Ø±" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none">
            </div>
            <input type="text" id="inp_note" placeholder="Ù…ÙˆØ§Ø¯ / ØªÛØ¨ÛŒÙ†ÛŒ" class="w-full p-3 bg-gray-50 rounded-xl outline-none mb-3">
            <div class="flex gap-3">
                <button onclick="saveRecord('Ù…Ø¶Ø§Ù')" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-100">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†</button>
                <button onclick="saveRecord('Ø³Ø­Ø¨')" class="flex-1 bg-red-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-red-100">Ø³Û•Ø±ÙÚ©Ø±Ø¯Ù†</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMbSkztcgeeNgqpgvKf_VnB9Q4MQKomzk",
            authDomain: "hisabat-5b935.firebaseapp.com",
            databaseURL: "https://Hisabat-5b935-default-rtdb.firebaseio.com",
            projectId: "hisabat-5b935",
            storageBucket: "hisabat-5b935.appspot.com",
            messagingSenderId: "925180562302",
            appId: "1:925180562302:android:7467c500ade5ab5900c12f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let correctPin = "";
        let transactionData = [];

        // Auth Logic
        function loginUser() {
            const e = document.getElementById('log_email').value;
            const p = document.getElementById('log_pass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login_screen').classList.add('hidden');
                document.getElementById('pin_screen').classList.remove('hidden');
                // Get PIN from Firebase
                db.ref('andam/' + user.uid).once('value', snap => {
                    correctPin = snap.val()?.PIN || "";
                });
            } else {
                document.getElementById('login_screen').classList.remove('hidden');
                document.getElementById('pin_screen').classList.add('hidden');
                document.getElementById('main_screen').classList.add('hidden');
            }
        });

        function checkPin() {
            const input = document.getElementById('pin_input').value;
            if (input === correctPin.toString()) {
                document.getElementById('pin_screen').classList.add('hidden');
                document.getElementById('main_screen').classList.remove('hidden');
                loadDashboard(auth.currentUser.uid);
            } else {
                const container = document.getElementById('pin_container');
                container.classList.add('shake');
                setTimeout(() => container.classList.remove('shake'), 500);
                document.getElementById('pin_input').value = "";
                if (window.navigator.vibrate) window.navigator.vibrate(200);
            }
        }

        function loadDashboard(uid) {
            // Profile & Balance
            db.ref('andam/' + uid).on('value', snap => {
                const d = snap.val();
                if(d) {
                    document.getElementById('user_name').innerText = d.name;
                    document.getElementById('balance').innerText = Number(d.para).toLocaleString();
                    let progress = (d.para / 7500000) * 100;
                    document.getElementById('progress_bar').style.width = Math.min(progress, 100) + '%';
                }
            });

            // Transactions
            db.ref('casher').on('value', snap => {
                const container = document.getElementById('transaction_list');
                container.innerHTML = '';
                transactionData = [];
                snap.forEach(child => {
                    if(child.val().uid === uid) transactionData.push(child.val());
                });
                renderList(transactionData.reverse());
            });
        }

        function renderList(data) {
            const container = document.getElementById('transaction_list');
            container.innerHTML = '';
            data.forEach(item => {
                const isExpense = item.color === 'Ø³Ø­Ø¨';
                const html = `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-r-4 ${isExpense ? 'border-red-500' : 'border-blue-500'} flex justify-between items-center transition active:scale-95">
                        <div class="text-right">
                            <h4 class="font-bold text-gray-800">${item.name}</h4>
                            <p class="text-[10px] text-gray-400">${item.tarex}</p>
                            <p class="text-xs text-gray-500 mt-1">${item.wasf}</p>
                        </div>
                        <div class="text-left">
                            <div class="font-black text-xl ${isExpense ? 'text-red-500' : 'text-blue-600'}">${Number(item.para).toLocaleString()}</div>
                            <div class="text-[9px] font-bold opacity-30 uppercase">${item.color}</div>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function searchTransactions() {
            const q = document.getElementById('search_box').value.toLowerCase();
            const filtered = transactionData.filter(i => i.name.toLowerCase().includes(q));
            renderList(filtered);
        }

        function saveRecord(type) {
            const amt = document.getElementById('inp_amt').value;
            const cli = document.getElementById('inp_cli').value;
            const note = document.getElementById('inp_note').value;
            const uid = auth.currentUser.uid;

            if(!amt || !cli) return alert("ØªÚ©Ø§ÛŒÛ• Ø®Ø§Ù†Û•Ú©Ø§Ù† Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•");

            const date = new Date();
            const timeStr = date.toLocaleDateString('en-GB') + " | " + date.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

            const key = db.ref('casher').push().key;
            db.ref('casher/' + key).set({
                name: cli, para: amt, wasf: note, tarex: timeStr, color: type, uid: uid, key: key
            });

            db.ref('andam/' + uid + '/para').transaction(curr => {
                return type === 'Ù…Ø¶Ø§Ù' ? (Number(curr) + Number(amt)) : (Number(curr) - Number(amt));
            });

            document.getElementById('inp_amt').value = '';
            document.getElementById('inp_cli').value = '';
            document.getElementById('inp_note').value = '';
        }

        function logout() { auth.signOut(); }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø³Ø§Ø¨Ø§Øª Pro - Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background: #F8F9FA; overflow-x: hidden; }
        .gold-card { background: linear-gradient(135deg, #FFD200 0%, #F7971E 100%); border-radius: 25px; }
        .hidden { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); }
        .price-menu { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(0.9) translateY(-20px); opacity: 0; pointer-events: none; }
        .price-menu.active { transform: scale(1) translateY(0); opacity: 1; pointer-events: auto; }
        .trend-up { color: #10b981; animation: bounce 1s infinite; }
        .trend-down { color: #ef4444; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="login_screen" class="flex-1 flex flex-col justify-center p-8 text-right">
        <h1 class="text-4xl font-black text-yellow-500 mb-2">Ø­Ø³Ø§Ø¨Ø§Øª</h1>
        <p class="mb-8 text-gray-500">Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª! ØªÚ©Ø§ÛŒÛ• Ø¨Ú†Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</p>
        <input type="email" id="log_email" placeholder="Ø¦ÛŒÙ…Û•ÛŒÚµ" class="w-full p-4 mb-4 bg-white rounded-2xl shadow-sm outline-none border border-gray-100 text-right">
        <input type="password" id="log_pass" placeholder="Ù¾Ø§Ø³ÙˆÛ†Ø±Ø¯" class="w-full p-4 mb-6 bg-white rounded-2xl shadow-sm outline-none border border-gray-100 text-right">
        <button onclick="loginUser()" class="w-full bg-black text-white py-4 rounded-2xl font-bold active:scale-95 transition">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
    </div>

    <div id="pin_screen" class="hidden flex-1 flex flex-col justify-center items-center p-8 bg-yellow-500 text-white text-center">
        <h2 class="text-2xl font-black mb-2">Ù¾Ø§Ø±Ø§Ø³ØªÙ†ÛŒ Ù‡Û•Ú˜Ù…Ø§Ø±</h2>
        <div id="pin_container" class="glass-panel p-8 rounded-[40px] shadow-2xl w-full max-sm:max-w-xs">
            <input type="password" id="pin_input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" class="w-full text-center text-4xl p-4 bg-yellow-50 rounded-2xl text-yellow-700 outline-none border-2 border-yellow-200 mb-6 font-mono text-right">
            <button onclick="checkPin()" class="w-full bg-yellow-600 text-white py-4 rounded-2xl font-bold shadow-md active:scale-95 transition">Ù¾Ø´ØªÚ•Ø§Ø³ØªÚ©Ø±Ø¯Ù†Û•ÙˆÛ•</button>
        </div>
    </div>

    <div id="main_screen" class="hidden flex-1 p-4 pb-56">
        <div class="flex justify-between items-center mb-6 relative text-right">
            <div id="user_name" class="bg-yellow-400 text-white px-3 py-1 rounded-xl text-[10px] font-black shadow-sm">...</div>
            
            <div class="flex gap-2">
                <button onclick="fetchPrices()" class="p-2 bg-blue-500 text-white rounded-xl shadow-md active:rotate-180 transition-all duration-500">ğŸ”„</button>
                
                <div onclick="togglePriceMenu()" class="cursor-pointer bg-white px-3 py-1 rounded-2xl shadow-md flex items-center gap-2 border border-yellow-100 active:scale-95 transition">
                    <span id="trend_icon" class="text-xs">--</span>
                    <div class="flex flex-col items-center">
                        <span class="text-[8px] text-gray-400 font-bold uppercase tracking-tighter">Live Price</span>
                        <span id="top_price_display" class="text-[11px] font-black text-gray-700">$0.00</span>
                    </div>
                    <span class="text-[10px]">â˜°</span>
                </div>
            </div>
            
            <button onclick="logout()" class="p-2 bg-white rounded-full shadow-md">ğŸšª</button>

            <div id="price_menu" class="price-menu absolute top-12 left-0 right-0 z-[100] glass-panel rounded-[30px] p-5 shadow-2xl">
                <h3 class="text-center text-[10px] font-bold text-gray-400 mb-4 uppercase text-center">Ù†Ø±Ø®Û•Ú©Ø§Ù†ÛŒ Ø¨Û†Ø±Ø³Û• Ùˆ Ø¨Ø§Ø²Ø§Ú•</h3>
                
                <div class="grid grid-cols-2 gap-3 text-right">
                    <div class="bg-yellow-50 p-3 rounded-2xl">
                        <p class="text-[9px] text-yellow-600 font-bold">Ø¦Û†Ù†Ø³Û•ÛŒ Ø²ÛÚ•</p>
                        <p id="menu_ounce" class="text-sm font-black text-gray-800">$0.00</p>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-2xl">
                        <p class="text-[9px] text-blue-600 font-bold">Ø¦Û†Ù†Ø³Û•ÛŒ Ø²ÛŒÙˆ</p>
                        <p id="menu_silver" class="text-sm font-black text-gray-800">$0.00</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded-xl col-span-2 flex justify-between items-center">
                        <span id="m24_val" class="font-black text-gray-800 text-xs">0</span>
                        <span class="text-[9px] text-gray-500 font-bold">Ù…Ø³Ù‚Ø§ÚµÛŒ Ù¢Ù¤</span>
                    </div>
                    <div class="bg-orange-50 p-2 rounded-xl col-span-2 flex justify-between items-center border-r-4 border-orange-300">
                        <span id="m22_val" class="font-black text-orange-700 text-xs">0</span>
                        <span class="text-[9px] text-gray-500 font-bold">Ù…Ø³Ù‚Ø§ÚµÛŒ Ù¢Ù¢</span>
                    </div>
                    <div class="bg-gray-50 p-2 rounded-xl col-span-2 flex justify-between items-center border-r-4 border-yellow-400">
                        <span id="m21_val" class="font-black text-yellow-600 text-xs">0</span>
                        <span class="text-[9px] text-gray-500 font-bold">Ù…Ø³Ù‚Ø§ÚµÛŒ Ù¢Ù¡</span>
                    </div>
                    <div class="bg-gray-50 p-2 rounded-xl col-span-2 flex justify-between items-center border-r-4 border-red-300">
                        <span id="m18_val" class="font-black text-red-600 text-xs">0</span>
                        <span class="text-[9px] text-gray-500 font-bold">Ù…Ø³Ù‚Ø§ÚµÛŒ Ù¡Ù¨</span>
                    </div>
                    <div class="bg-indigo-50 p-2 rounded-xl col-span-2 flex justify-between items-center">
                        <span id="msilver_val" class="font-black text-indigo-700 text-xs">0</span>
                        <span class="text-[9px] text-indigo-400 font-bold">Ù…Ø³Ù‚Ø§ÚµÛŒ Ø²ÛŒÙˆ</span>
                    </div>
                </div>
                
                <button onclick="copyPricesForTelegram()" class="w-full mt-4 bg-green-600 text-white py-3 rounded-2xl font-bold text-xs shadow-md active:scale-95 transition flex items-center justify-center gap-2">
                    ğŸ“‹ Ú©Û†Ù¾ÛŒ Ø¨Û† ØªÛÙ„ÛŒÚ¯Ø±Ø§Ù…
                </button>
            </div>
        </div>

        <div class="gold-card p-6 text-white text-center shadow-xl mb-6 relative overflow-hidden">
            <div class="absolute -right-10 -top-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
            <p class="text-xs opacity-80">Ú•Û•Ø³ÛŒØ¯ÛŒ Ø¦ÛØ³ØªØ§</p>
            <h2 id="balance" class="text-4xl font-black my-1 tracking-tight">0</h2>
            <div class="mt-2 flex justify-center gap-2 items-center bg-black/10 py-1 px-4 rounded-full inline-flex">
                <span class="text-[10px] opacity-70">Ù¡Ù Ù $ =</span>
                <input type="number" id="web_usd_rate" value="150000" oninput="calculateAllPrices()" class="bg-transparent w-16 text-center text-xs font-bold outline-none border-none">
            </div>
        </div>

        <input type="text" id="search_box" oninput="searchTransactions()" placeholder="Ú¯Û•Ú•Ø§Ù† Ø¨Û† Ù†Ø§Ùˆ..." class="w-full p-4 rounded-2xl border-none shadow-sm mb-6 outline-none text-right text-sm">
        <div id="transaction_list" class="space-y-3"></div>

        <div class="fixed bottom-0 left-0 right-0 glass-panel p-4 rounded-t-[40px] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-50">
            <div class="flex gap-2 mb-2">
                <input type="number" id="inp_amt" placeholder="Ù¾Ø§Ø±Û•" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none text-right text-sm">
                <input type="text" id="inp_cli" placeholder="Ú©Ú•ÛŒØ§Ø±" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none text-right text-sm">
            </div>
            <input type="text" id="inp_note" placeholder="Ù…ÙˆØ§Ø¯ / ØªÛØ¨ÛŒÙ†ÛŒ" class="w-full p-3 bg-gray-50 rounded-xl outline-none mb-3 text-right text-sm">
            <div class="flex gap-3">
                <button onclick="saveRecord('Ù…Ø¶Ø§Ù')" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†</button>
                <button onclick="saveRecord('Ø³Ø­Ø¨')" class="flex-1 bg-red-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition">Ø³Û•Ø±ÙÚ©Ø±Ø¯Ù†</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMbSkztcgeeNgqpgvKf_VnB9Q4MQKomzk",
            authDomain: "hisabat-5b935.firebaseapp.com",
            databaseURL: "https://Hisabat-5b935-default-rtdb.firebaseio.com",
            projectId: "hisabat-5b935",
            storageBucket: "hisabat-5b935.appspot.com",
            messagingSenderId: "925180562302",
            appId: "1:925180562302:android:7467c500ade5ab5900c12f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentOunce = 0;
        let lastOunce = 0;
        let currentSilverOunce = 0;

        function togglePriceMenu() {
            document.getElementById('price_menu').classList.toggle('active');
        }

        async function fetchPrices() {
            try {
                const gRes = await fetch('https://api.gold-api.com/price/XAU');
                const gData = await gRes.json();
                lastOunce = currentOunce;
                currentOunce = gData.price;

                const sRes = await fetch('https://api.gold-api.com/price/XAG');
                const sData = await sRes.json();
                currentSilverOunce = sData.price;

                calculateAllPrices();
                updateTrend();
            } catch (e) { console.log("Price Error"); }
        }

        function calculateAllPrices() {
            if (currentOunce === 0) return;
            const usd = document.getElementById('web_usd_rate').value || 150000;
            const usdFactor = usd / 100;
            
            const gBase = (currentOunce / 31.1035) * 4.8 * usdFactor;
            
            // Ú†Ø§Ú©Ú©Ø±Ø¯Ù†ÛŒ Ø­Û•Ù‚Ø¯Û•Ø³ØªÛ•Ú©Ø§Ù† - Ù„ÛØ±Û• Ù£Ù Ù Ù  Ù„Û• Ø¹Û•ÛŒØ§Ø± Ù¢Ù¡ Ú©Û•Ù…Ú©Ø±Ø§ÛŒÛ•ÙˆÛ•
            const m24 = gBase + 45000;
            const m22 = (gBase * 0.916) + 70000; 
            const m21 = (gBase * 0.875) + 85000; // Ú©Û•Ù…Ú©Ø±Ø§ÛŒÛ•ÙˆÛ• Ø¨Û† Ù¨Ù¥Ù Ù Ù 
            const m18 = (gBase * 0.750) + 98000; 
            const mSilver = (currentSilverOunce / 31.1035 * 4.8) * usdFactor + 15000;

            document.getElementById('top_price_display').innerText = "$" + currentOunce.toFixed(2);
            document.getElementById('menu_ounce').innerText = "$" + currentOunce.toFixed(2);
            document.getElementById('menu_silver').innerText = "$" + currentSilverOunce.toFixed(2);
            
            document.getElementById('m24_val').innerText = Math.round(m24).toLocaleString() + " IQD";
            document.getElementById('m22_val').innerText = Math.round(m22).toLocaleString() + " IQD";
            document.getElementById('m21_val').innerText = Math.round(m21).toLocaleString() + " IQD";
            document.getElementById('m18_val').innerText = Math.round(m18).toLocaleString() + " IQD";
            document.getElementById('msilver_val').innerText = Math.round(mSilver).toLocaleString() + " IQD";
        }

        function copyPricesForTelegram() {
            const ounce = document.getElementById('menu_ounce').innerText;
            const silverOunce = document.getElementById('menu_silver').innerText;
            const m24 = document.getElementById('m24_val').innerText;
            const m22 = document.getElementById('m22_val').innerText;
            const m21 = document.getElementById('m21_val').innerText;
            const m18 = document.getElementById('m18_val').innerText;
            const mSilver = document.getElementById('msilver_val').innerText;
            
            const baghdadTime = new Date().toLocaleString("en-GB", {
                timeZone: "Asia/Baghdad",
                hour12: true,
                hour: '2-digit',
                minute: '2-digit'
            });
            const baghdadDate = new Date().toLocaleDateString("en-GB", {timeZone: "Asia/Baghdad"});
            
            const trend = currentOunce >= lastOunce ? "ğŸŸ¢ ğŸ”º" : "ğŸ”´ ğŸ”»";

            const text = `âœ¨ **GOLD & SILVER | Ø²ÛÚ• Ùˆ Ø²ÛŒÙˆ** âœ¨\nğŸ“Š **Ø¯ÙˆØ§ÛŒÙ† Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ Ø¨Ø§Ø²Ø§Ú•**\n\nâ”€â”€â”€ â”€â”€â”€ â”€â”€â”€ â”€â”€â”€ â”€â”€â”€\n**ğŸŒ ã€ Ø¨Û†Ø±Ø³Û•ÛŒ Ø¬ÛŒÙ‡Ø§Ù†ÛŒ ã€‘**\nğŸŸ¡ Ø¦Û†Ù†Ø³Û•ÛŒ Ø²ÛÚ• â‡› \`${ounce}\` ${trend}\nâšªï¸ Ø¦Û†Ù†Ø³Û•ÛŒ Ø²ÛŒÙˆ â‡› \`${silverOunce}\` ${trend}\n\n**ğŸ‡®ğŸ‡¶ ã€ Ù†Ø±Ø®Ù€ÛŒ Ø²ÛÚ•ÛŒ Ø¹ÛÙ€Ø±Ø§Ù‚ÛŒ ã€‘**\nğŸ’° Ù…Ø³Ù‚Ø§ÚµÛŒ Ù¢Ù¤ â‡› \`${m24}\` ğŸŸ¢\nğŸ”¶ Ù…Ø³Ù‚Ø§ÚµÛŒ Ù¢Ù¢ â‡› \`${m22}\` ğŸŸ¢\nâšœï¸ Ù…Ø³Ù‚Ø§ÚµÛŒ Ù¢Ù¡ â‡› \`${m21}\` ğŸŸ¢\nâœ¨ Ù…Ø³Ù‚Ø§ÚµÛŒ Ù¡Ù¨ â‡› \`${m18}\` ğŸŸ¢\n\n**ğŸ’¿ ã€ Ù†Ø±Ø®Ù€ÛŒ Ø²ÛŒÙ€ÙˆÛŒ Ø®Ù€Ø§Ùˆ ã€‘**\nğŸ”˜ Ù…Ø³Ù‚Ø§ÚµÛŒ Ø²ÛŒÙˆ â‡› \`${mSilver}\` ğŸŸ¢\nâ”€â”€â”€ â”€â”€â”€ â”€â”€â”€ â”€â”€â”€ â”€â”€â”€\n\nâš¡ï¸ **Ù†ÙˆÛØ¨ÙˆÙˆÙ†Û•ÙˆÛ•ÛŒ Ø®ÛØ±Ø§ Ø¨Û• Ú†Ø±Ú©Û•**\nğŸ“… ${baghdadDate} | â° ${baghdadTime}\n\nğŸ“¢ @zerwzew1`;

            navigator.clipboard.writeText(text).then(() => {
                alert("Ù†Ø±Ø®Û•Ú©Ø§Ù† Ø¨Û• Ú©Ø§ØªÛŒ Ø¨Û•ØºØ¯Ø§Ø¯ Ú©Û†Ù¾ÛŒ Ø¨ÙˆÙˆÙ†!");
            });
        }

        function updateTrend() {
            const icon = document.getElementById('trend_icon');
            if (currentOunce > lastOunce && lastOunce !== 0) {
                icon.innerHTML = "â–²";
                icon.className = "text-[10px] trend-up";
            } else if (currentOunce < lastOunce && lastOunce !== 0) {
                icon.innerHTML = "â–¼";
                icon.className = "text-[10px] trend-down";
            }
        }

        setInterval(fetchPrices, 10000); // Ø¦Û†ØªÛ†Ù…Ø§ØªÛŒÚ© Ù‡Û•Ù…ÙˆÙˆ Ù¡Ù  Ú†Ø±Ú©Û•

        // Firebase & Business Logic
        let correctPin = "";
        let transactionData = [];

        function loginUser() {
            const e = document.getElementById('log_email').value;
            const p = document.getElementById('log_pass').value;
            if(!e || !p) return;
            auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login_screen').classList.add('hidden');
                document.getElementById('pin_screen').classList.remove('hidden');
                db.ref('andam/' + user.uid).once('value', snap => {
                    correctPin = snap.val()?.PIN || "";
                });
            } else {
                document.getElementById('login_screen').classList.remove('hidden');
                document.getElementById('pin_screen').classList.add('hidden');
                document.getElementById('main_screen').classList.add('hidden');
            }
        });

        function checkPin() {
            const input = document.getElementById('pin_input').value;
            if (input === correctPin.toString()) {
                document.getElementById('pin_screen').classList.add('hidden');
                document.getElementById('main_screen').classList.remove('hidden');
                loadDashboard(auth.currentUser.uid);
                fetchPrices();
            } else {
                document.getElementById('pin_input').value = "";
            }
        }

        function loadDashboard(uid) {
            db.ref('andam/' + uid).on('value', snap => {
                const d = snap.val();
                if(d) {
                    document.getElementById('user_name').innerText = d.name;
                    document.getElementById('balance').innerText = Number(d.para).toLocaleString() + " IQD";
                }
            });
            db.ref('casher').on('value', snap => {
                transactionData = [];
                snap.forEach(child => {
                    if(child.val().uid === uid) transactionData.push(child.val());
                });
                renderList(transactionData.reverse());
            });
        }

        function renderList(data) {
            const container = document.getElementById('transaction_list');
            container.innerHTML = '';
            data.forEach(item => {
                const isExpense = item.color === 'Ø³Ø­Ø¨';
                const html = `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-r-4 ${isExpense ? 'border-red-500' : 'border-blue-500'} flex justify-between items-center active:scale-95 transition text-right">
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">${item.name}</h4>
                            <p class="text-[9px] text-gray-400">${item.tarex}</p>
                            <p class="text-[11px] text-gray-500 mt-1">${item.wasf}</p>
                        </div>
                        <div class="text-left font-black text-sm ${isExpense ? 'text-red-500' : 'text-blue-600'}">
                            ${Number(item.para).toLocaleString()}
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function searchTransactions() {
            const q = document.getElementById('search_box').value.toLowerCase();
            const filtered = transactionData.filter(i => i.name.toLowerCase().includes(q));
            renderList(filtered);
        }

        function saveRecord(type) {
            const amt = document.getElementById('inp_amt').value;
            const cli = document.getElementById('inp_cli').value;
            const note = document.getElementById('inp_note').value;
            const uid = auth.currentUser.uid;
            if(!amt || !cli) return;
            const date = new Date();
            const timeStr = date.toLocaleDateString('en-GB') + " | " + date.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
            const key = db.ref('casher').push().key;
            db.ref('casher/' + key).set({ name: cli, para: amt, wasf: note, tarex: timeStr, color: type, uid: uid, key: key });
            db.ref('andam/' + uid + '/para').transaction(curr => type === 'Ù…Ø¶Ø§Ù' ? (Number(curr) + Number(amt)) : (Number(curr) - Number(amt)));
            document.getElementById('inp_amt').value = ''; document.getElementById('inp_cli').value = ''; document.getElementById('inp_note').value = '';
        }

        function logout() { auth.signOut(); }
    </script>
</body>
</html>
